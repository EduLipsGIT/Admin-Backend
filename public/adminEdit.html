<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>EduLips Author</title>

    <style>
      body {
        margin: 0;
        font-family:
          Inter,
          Segoe UI,
          sans-serif;
        background: #f6f7f9;
        color: #333;
      }

      .container {
        display: flex;
        height: 100vh;
        transition: all 0.3s ease;
      }

      /* ------------ SIDEBAR ------------ */
      .sidebar {
        width: 260px;
        background: #fff;
        padding: 25px;
        border-right: 1px solid #e5e7eb;
        overflow-y: auto;
        transition: width 0.3s ease;
      }

      .sidebar.hidden {
        width: 0;
        padding: 0;
        opacity: 0;
        overflow: hidden;
      }

      .sidebar h3 {
        font-size: 15px;
        margin-bottom: 10px;
        font-weight: 600;
      }

      .filter-block {
        margin-bottom: 28px;
      }

      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        height: 120px;
        background: #fff;
      }

      .select-all {
        background: none;
        border: none;
        font-size: 13px;
        color: #2563eb;
        cursor: pointer;
        margin-bottom: 6px;
      }

      /* ------------ MAIN CONTENT ------------ */
      .main {
        flex: 1;
        padding: 25px 35px;
        overflow-y: auto;
      }

      /* Toggle Button */
      .toggle-btn {
        background: #2563eb;
        color: #fff;
        border: none;
        padding: 10px 14px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        margin-bottom: 20px;
      }

      /* --------- STATS CARD --------- */
      .stats-row {
        display: flex;
        gap: 20px;
        margin-bottom: 25px;
      }

      .stat-card {
        background: #fff;
        padding: 18px 20px;
        border-radius: 12px;
        flex: 1;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
        font-size: 14px;
        max-width: 220px;
      }

      .stat-title {
        color: #6b7280;
        margin-bottom: 6px;
      }

      .stat-value {
        font-size: 22px;
        font-weight: 700;
      }

      .search-box {
        flex: 1;
      }

      .search-box input {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid #d1d5db;
        background: #fff;
        border-radius: 10px;
        font-size: 14px;
      }

      /* ------------ TABLE ------------ */
      table {
        width: 100%;
        background: #fff;
        border-collapse: collapse;
        border-radius: 12px;
        overflow: hidden;
        font-size: 14px;
      }

      th {
        background: #f9fafb;
        text-align: left;
        padding: 12px;
        font-weight: 600;
        border-bottom: 1px solid #e5e7eb;
      }

      td {
        padding: 12px;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: top;
        color: #374151;
      }

      .edit-btn {
        cursor: pointer;
        color: #2563eb;
        font-size: 14px;
      }
    </style>
  </head>

  <!-- Loading Overlay -->
  <div
    id="loadingOverlay"
    style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.2);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    "
  >
    <div
      style="
        width: 60px;
        height: 60px;
        border: 6px solid #f3f3f3;
        border-top: 6px solid #2563eb;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      "
    ></div>
  </div>

  <style>
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    /* ---------- UNIFIED BUTTON SYSTEM ---------- */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;

      padding: 10px 14px;
      font-size: 14px;
      font-weight: 500;

      border: none;
      border-radius: 8px;
      cursor: pointer;

      color: #fff;
      background: #2563eb;

      transition: all 0.2s ease;
    }

    .btn:hover {
      filter: brightness(0.95);
    }

    .btn:active {
      transform: scale(0.97);
    }

    /* Variants */
    .btn-green {
      background: #059669;
    }

    .btn-red {
      background: #dc2626;
    }

    .btn-gray {
      background: #374151;
    }

    .btn-outline {
      background: #fff;
      color: #2563eb;
      border: 1px solid #2563eb;
    }

    .btn-sm {
      padding: 8px 12px;
      font-size: 13px;
    }

    /* ---------- TOP HEADER BAR ---------- */
    .top-header {
      display: flex;
      align-items: center;
      gap: 16px;

      background: #fff;
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 18px;

      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .header-left,
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-center {
      flex: 1;
      margin-right: 24px;
    }

    .header-center input {
      width: 100%;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    /* Compact stat card */
    .stat-compact {
      padding: 6px 12px;
      min-width: 90px;
      text-align: center;
    }

    .stat-compact .stat-title {
      font-size: 11px;
    }

    .stat-compact .stat-value {
      font-size: 18px;
    }
  </style>

  <body>
    <div class="container">
      <!-- ============ SIDEBAR ============ -->
      <div class="sidebar" id="sidebar">
        <div class="filter-block">
          <h3>Select Exams</h3>
          <select id="examDropdown" multiple></select>
        </div>

        <div class="filter-block">
          <h3>Select Subjects</h3>
          <select id="subjectDropdown" multiple></select>
        </div>

        <div class="filter-block">
          <h3>Select Sections</h3>
          <button class="select-all" onclick="selectAll('sectionDropdown')">
            Select All
          </button>
          <select id="sectionDropdown" multiple></select>
        </div>

        <div class="filter-block">
          <h3>Select Chapters</h3>
          <button class="select-all" onclick="selectAll('chapterDropdown')">
            Select All
          </button>
          <select id="chapterDropdown" multiple></select>
        </div>

        <div class="filter-block">
          <h3>Select Level</h3>
          <button class="select-all" onclick="selectAll('levelDropdown')">
            Select All
          </button>
          <select id="levelDropdown" multiple></select>
        </div>
      </div>

      <!-- ============ MAIN PANEL ============ -->
      <div class="main">
        <!-- Sidebar Toggle + Total Questions -->
        <div class="top-header">
          <!-- Left -->
          <div class="header-left">
            <button class="btn btn-outline" onclick="toggleSidebar()">
              ‚ò∞ Show/Hide
            </button>
            <div class="stat-card stat-compact">
              <div class="stat-title">QUES LOADED</div>
              <div id="totalQuestions" class="stat-value">0</div>
            </div>
          </div>

          <!-- Center -->
          <div class="header-center">
            <input
              id="searchInput"
              type="text"
              placeholder="Search by keyword or ID‚Ä¶"
            />
          </div>

          <!-- Right -->
          <div class="header-right">
            <button class="btn btn-outline" onclick="openBulkModal()">
              Bulk Images Upload
            </button>

            <button
              id="loadReportedBtn"
              class="btn btn-outline"
              style="display: none"
              onclick="loadReportedQuestions()"
            >
              Load Reported Ques
            </button>

            <button class="btn btn-outline" onclick="downloadExcel()">
              Standard Format
            </button>
            <button class="btn btn-outline" onclick="downloadFilteredExcel()">
              Download
            </button>
            <button
              id="uploadExcelBtn"
              class="btn btn-outline"
              onclick="selectExcelFile()"
            >
              Upload XLSX
            </button>

            <button class="btn btn-gray" onclick="handleLogout()">
              Logout
            </button>
          </div>
        </div>

        <!-- TABLE -->
        <table id="excelTable"></table>
      </div>
    </div>

    <!-- SheetJS Library -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <script>
      let USER_ROLE = "admin";
      // const API = "http://localhost:3000";
      const API = "https://author.edulips.com";

      /* ----------------- LOGIN CHECK ----------------- */
      async function checkLogin() {
        const isLoggedIn = localStorage.getItem("isLoggedIn");
        const username = localStorage.getItem("username");

        if (!isLoggedIn || !username) {
          window.location.href = "login.html";
          return;
        }

        try {
          const res = await fetch(`${API}/auth/resolve-role`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username }),
          });

          const data = await res.json();

          if (!data.success) {
            alert("Access denied");
            window.location.href = "login.html";
            return;
          }

          USER_ROLE = data.role; // "super_admin" | "admin"

          if (USER_ROLE === "super_admin") {
            document.getElementById("loadReportedBtn").style.display =
              "inline-block";
            document.getElementById("uploadExcelBtn").style.display =
              "inline-block";
          }
        } catch (error) {
          console.error("Role resolve failed:", error);
          USER_ROLE = "admin"; // safe fallback
        }
      }
      window.onload = checkLogin;

      /* ----------------- Loader ----------------- */
      function showLoader() {
        document.getElementById("loadingOverlay").style.display = "flex";
      }
      function hideLoader() {
        document.getElementById("loadingOverlay").style.display = "none";
      }

      /* ----------------- Sidebar ----------------- */
      function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("hidden");
      }

      function getSelectedValues(selectEl) {
        return Array.from(selectEl.selectedOptions).map((o) => o.value);
      }

      function selectAll(id) {
        const el = document.getElementById(id);
        for (let opt of el.options) opt.selected = true;
        el.dispatchEvent(new Event("change"));
      }

      /* ----------------- Load Exams ----------------- */
      async function loadExams() {
        try {
          showLoader();
          const exams = await fetch(`${API}/exams`).then((r) => r.json());
          document.getElementById("examDropdown").innerHTML = exams
            .map((e) => `<option value="${e}">${e}</option>`)
            .join("");
        } finally {
          hideLoader();
        }
      }
      loadExams();

      /* ----------------- Subjects ----------------- */
      document
        .getElementById("examDropdown")
        .addEventListener("change", async function () {
          showLoader();
          try {
            const exams = getSelectedValues(this);
            const subjectsEl = document.getElementById("subjectDropdown");
            subjectsEl.innerHTML = "";

            let all = new Set();
            for (let e of exams) {
              const subs = await fetch(
                `${API}/subjects?exam=${encodeURIComponent(e)}`,
              ).then((r) => r.json());
              subs.forEach((s) => all.add(`${e}|${s}`));
            }

            subjectsEl.innerHTML = [...all]
              .map((s) => `<option value="${s}">${s.split("|")[1]}</option>`)
              .join("");
          } finally {
            hideLoader();
          }
        });

      /* ----------------- Sections ----------------- */
      document
        .getElementById("subjectDropdown")
        .addEventListener("change", async function () {
          showLoader();
          try {
            const selected = getSelectedValues(this);
            const secEl = document.getElementById("sectionDropdown");
            secEl.innerHTML = "";

            let all = new Set();
            for (let v of selected) {
              const [exam, subject] = v.split("|");
              const secs = await fetch(
                `${API}/sections?exam=${encodeURIComponent(exam)}&subject=${encodeURIComponent(subject)}`,
              ).then((r) => r.json());
              secs.forEach((s) => all.add(`${exam}|${subject}|${s}`));
            }

            secEl.innerHTML = [...all]
              .map((v) => `<option value="${v}">${v.split("|")[2]}</option>`)
              .join("");
          } finally {
            hideLoader();
          }
        });

      /* ----------------- Chapters ----------------- */
      document
        .getElementById("sectionDropdown")
        .addEventListener("change", async function () {
          showLoader();
          try {
            const selected = getSelectedValues(this);
            const chEl = document.getElementById("chapterDropdown");
            chEl.innerHTML = "";

            let all = new Set();
            for (let v of selected) {
              const [exam, subject, section] = v.split("|");
              const chs = await fetch(
                `${API}/chapters?exam=${encodeURIComponent(exam)}&subject=${encodeURIComponent(subject)}&section=${encodeURIComponent(section)}`,
              ).then((r) => r.json());
              chs.forEach((c) => all.add(`${exam}|${subject}|${section}|${c}`));
            }

            chEl.innerHTML = [...all]
              .map((v) => `<option value="${v}">${v.split("|")[3]}</option>`)
              .join("");
          } finally {
            hideLoader();
          }
        });

      /* ----------------- GLOBAL QUESTIONS STORE (New) ----------------- */
      let ALL_QUESTIONS = {}; // ‚≠ê NEW

      /* ----------------- Load Questions ----------------- */
      document
        .getElementById("chapterDropdown")
        .addEventListener("change", async function () {
          showLoader();
          try {
            const selected = getSelectedValues(this);
            if (!selected.length) return renderTable({});

            const [exam, subject, section] = selected[0].split("|");
            const chapters = selected.map((c) => c.split("|")[3]).join(",");

            const questions = await fetch(
              `${API}/questions?exam=${encodeURIComponent(exam)}
&subject=${encodeURIComponent(subject)}
&section=${encodeURIComponent(section)}
&chapters=${encodeURIComponent(chapters)}`,
            ).then((r) => r.json());

            ALL_QUESTIONS = questions; // ‚≠ê SAVE FULL LIST
            loadLevels(questions); // ‚≠ê AUTO-LOAD LEVELS
            applyFilters(); // ‚≠ê APPLY LEVEL FILTER

            document.getElementById("totalQuestions").innerText =
              Object.keys(questions).length;
          } finally {
            hideLoader();
          }
        });

      /* ----------------- Auto-Load Levels (New) ----------------- */
      function loadLevels(data) {
        const levelEl = document.getElementById("levelDropdown");
        levelEl.innerHTML = "";

        const levels = new Set();

        Object.values(data).forEach((q) => {
          if (q.level) levels.add(q.level.trim());
        });

        levelEl.innerHTML = [...levels]
          .map((l) => `<option value="${l}">${l}</option>`)
          .join("");
      }

      /* ----------------- LEVEL FILTER (New) ----------------- */
      document
        .getElementById("levelDropdown")
        .addEventListener("change", function () {
          applyFilters();
        });

      /* ----------------- APPLY ALL CLIENT-SIDE FILTERS (New) ----------------- */
      function applyFilters() {
        const selectedLevels = getSelectedValues(
          document.getElementById("levelDropdown"),
        );

        let filtered = {};

        Object.keys(ALL_QUESTIONS).forEach((id) => {
          const q = ALL_QUESTIONS[id];

          // LEVEL filter
          if (selectedLevels.length && !selectedLevels.includes(q.level))
            return;

          filtered[id] = q;
        });

        renderTable(filtered);
      }

      /* ----------------- Table Renderer ----------------- */
      function renderTable(data) {
        const table = document.getElementById("excelTable");
        table.innerHTML = "";

        const keys = Object.keys(data);
        if (!keys.length) {
          table.innerHTML = "<tr><td>No Questions Found</td></tr>";
          return;
        }

        // ---------- FIXED ORDERED COLUMNS ----------
        const FIXED_COLUMNS = [
          "ques",
          "opt1",
          "opt2",
          "opt3",
          "opt4",
          "CorrectAns",
          "desc_quiz",
          "ques_hin",
          "opt1_hin",
          "opt2_hin",
          "opt3_hin",
          "opt4_hin",
          "CorrectAns_hin",
          "desc_quiz_hin",
          "level",
        ];

        // ---------- FIND EXTRA COLUMNS AUTOMATICALLY ----------
        const sample = data[keys[0]];
        const allCols = Object.keys(sample);

        const BLOCKED_COLS = [
          "Exam/Category",
          "Subject",
          "Section",
          "Chapter",
          "Exam_Category",
          "Study",
        ];

        const extraCols = allCols.filter(
          (c) => !FIXED_COLUMNS.includes(c) && !BLOCKED_COLS.includes(c),
        );

        const FINAL_COLUMNS = [...FIXED_COLUMNS, ...extraCols];

        const cols = [
          "QID",
          ...FINAL_COLUMNS,
          USER_ROLE === "super_admin" ? "Actions" : "Feedback",
        ];

        // ---------- HEADER ----------
        table.innerHTML = `
    <tr>
      ${cols.map((c) => `<th>${c}</th>`).join("")}
    </tr>
  `;

        // ---------- ROWS ----------
        keys.forEach((qid) => {
          const hasImage = data[qid].IMG && data[qid].IMG.trim() !== "";

          let actionCell = "";

          // ‚≠ê SUPER ADMIN OPTIONS
          if (USER_ROLE === "super_admin") {
            actionCell += `
        <span class="edit-btn" onclick="updateQuestion('${qid}', this)">
          Update
        </span><br>

        <span class="edit-btn" style="color:red;" onclick="deleteQuestion('${qid}', this)">
          Delete
        </span><br><br>
      `;

            if (hasImage) {
              actionCell += `
          <div style="font-size:12px; color:#6b7280; margin-bottom:4px;">
            Expected: <b>${data[qid].IMG}</b>
          </div>

          <input
            type="file"
            accept="image/*"
            style="display:none"
            onchange="handleImageSelect('${qid}', this)"
          />

          <span class="edit-btn" onclick="triggerImageUpload(this)">
            üì∑ Upload Image
          </span>
          <br><br>
        `;
            } else {
              actionCell += `
          <span style="color:#9ca3af; font-size:12px;">
            No image reference
          </span>
          <br><br>
        `;
            }
          }

          // ‚≠ê REPORT OPTION FOR BOTH (super_admin + normal users)
          actionCell += `
      <textarea
        placeholder="Suggestion / Issue"
        style="width:100%; min-height:50px; font-size:13px;">
      </textarea>
      <br>
      <span class="edit-btn" onclick="reportQuestion('${qid}', this)">
        üö© Report
      </span>
    `;

          const row = `
      <tr>
        <td>${qid}</td>

        ${FINAL_COLUMNS.map(
          (col) => `
            <td contenteditable="${USER_ROLE === "super_admin"}" data-col="${col}">
              ${data[qid][col] || ""}
            </td>
          `,
        ).join("")}

        <td>${actionCell}</td>
      </tr>
    `;

          table.innerHTML += row;
        });
      }

      /* ----------------- Search ----------------- */
      document
        .getElementById("searchInput")
        .addEventListener("keyup", function () {
          const q = this.value.toLowerCase();
          const rows = document.querySelectorAll("#excelTable tr");

          rows.forEach((row, i) => {
            if (i === 0) return;
            row.style.display = row.innerText.toLowerCase().includes(q)
              ? ""
              : "none";
          });
        });

      /* ----------------- Update Question ----------------- */
      async function updateQuestion(qid, btn) {
        showLoader();
        try {
          const row = btn.closest("tr");
          const cells = row.querySelectorAll("td[contenteditable]");

          let updated = {};
          cells.forEach((c) => (updated[c.dataset.col] = c.innerText.trim()));

          const r = await fetch(`${API}/update-question`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ qid, data: updated }),
          }).then((r) => r.json());

          btn.textContent = r.success ? "Updated ‚úì" : "Error ‚úó";
          setTimeout(() => (btn.textContent = "Update"), 1200);
        } finally {
          hideLoader();
        }
      }

      /* ----------------- Delete Question ----------------- */
      async function deleteQuestion(qid, btn) {
        if (!confirm("Are you sure you want to delete this question?")) return;
        showLoader();
        try {
          const r = await fetch(`${API}/delete-question`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ qid }),
          }).then((r) => r.json());

          if (r.success) {
            btn.closest("tr").remove();
            const totalEl = document.getElementById("totalQuestions");
            totalEl.innerText = parseInt(totalEl.innerText) - 1;
          } else {
            alert("Failed to delete question.");
          }
        } finally {
          hideLoader();
        }
      }

      /* ----------------- Download Excel ----------------- */
      function downloadExcel() {
        const table = document.getElementById("excelTable");

        if (!table || table.rows.length <= 1) {
          alert("No data available to download.");
          return;
        }

        const ws = XLSX.utils.table_to_sheet(table);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Questions");

        XLSX.writeFile(wb, "questions.xlsx");
      }

      async function reportQuestion(qid, btn) {
        const row = btn.closest("tr");
        const textarea = row.querySelector("textarea");
        const message = textarea.value.trim();
        const username = localStorage.getItem("username");

        if (!message) {
          alert("Please enter a suggestion or issue.");
          return;
        }

        if (!username) {
          alert("Session expired. Please login again.");
          window.location.href = "login.html";
          return;
        }

        showLoader();

        try {
          const response = await fetch(`${API}/report-question`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              qid,
              message,
              username,
            }),
          });

          if (!response.ok) {
            console.error(
              "Report API failed:",
              response.status,
              response.statusText,
            );
            alert("Failed to submit report.");
            return;
          }

          const res = await response.json();

          if (res.success) {
            textarea.value = "";
            btn.textContent = "Reported ‚úì";
            btn.style.pointerEvents = "none";
            setTimeout(() => {
              btn.textContent = "üö© Report";
              btn.style.pointerEvents = "auto";
            }, 1500);
          } else {
            console.error("Report rejected:", res);
            alert(res.message || "Report failed.");
          }
        } catch (error) {
          console.error("Network error while reporting:", error);
          alert("Network error. Please try again.");
        } finally {
          hideLoader();
        }
      }
      async function loadReportedQuestions() {
        if (USER_ROLE !== "super_admin") return;

        toggleSidebar();
        showLoader();

        try {
          const res = await fetch(`${API}/reported-questions`);
          const json = await res.json();

          if (!json.success) {
            alert("Failed to load reported questions");
            return;
          }

          // Reset global store
          ALL_QUESTIONS = json.data || {};

          // Clear filters & stats
          document.getElementById("totalQuestions").innerText =
            Object.keys(ALL_QUESTIONS).length;

          renderTable(ALL_QUESTIONS);
        } catch (error) {
          console.error("Load reported questions failed:", error);
          alert("Error loading reported questions");
        } finally {
          hideLoader();
        }
      }

      function handleLogout() {
        localStorage.removeItem("isLoggedIn");
        localStorage.removeItem("username"); // optional but recommended
        window.location.href = "login.html";
      }
      function triggerImageUpload(btn) {
        const fileInput = btn.previousElementSibling;
        if (fileInput) {
          fileInput.click(); // üëà opens file explorer
        }
      }
      async function handleImageSelect(qid, input) {
        const file = input.files[0];
        if (!file) return;

        const question = ALL_QUESTIONS[qid];

        if (!question || !question.IMG) {
          alert("No image reference found for this question.");
          input.value = "";
          return;
        }

        const expectedBaseName = removeExtension(question.IMG.trim());
        const selectedBaseName = removeExtension(file.name.trim());

        // ‚úÖ Compare without extension
        if (expectedBaseName !== selectedBaseName) {
          alert(
            `Image name mismatch!\n\nExpected: ${expectedBaseName}\nSelected: ${selectedBaseName}`,
          );
          input.value = "";
          return;
        }

        // ‚úÖ Matched ‚Üí upload
        await uploadQuestionImage(qid, file);
      }
      async function uploadQuestionImage(qid, file, silent = false) {
        try {
          const formData = new FormData();
          formData.append("qid", qid);
          formData.append("image", file);

          const res = await fetch(`${API}/upload-question-image`, {
            method: "POST",
            body: formData,
          });

          const json = await res.json();

          if (!json.success) {
            if (!silent) {
              alert(json.message || "Image upload failed");
            }
            return false;
          }

          if (!silent) {
            alert("‚úÖ Image uploaded successfully");
          }

          return true;
        } catch (error) {
          console.error("Image upload error:", error);
          if (!silent) {
            alert("Network error while uploading image");
          }
          return false;
        }
      }

      function removeExtension(filename) {
        return filename.replace(/\.[^/.]+$/, "");
      }

      let BULK_FILES = []; // { file, qid, matched }

      function openBulkModal() {
        document.getElementById("bulkUploadModal").style.display = "flex";
      }

      function closeBulkModal() {
        document.getElementById("bulkUploadModal").style.display = "none";
        document.getElementById("bulkImageGrid").innerHTML = "";
        document.getElementById("bulkStats").innerText = "";
        BULK_FILES = [];
      }

      function selectBulkImages() {
        document.getElementById("bulkImageInput").click();
      }
      function handleBulkPreview(input) {
        const files = Array.from(input.files);
        if (!files.length) return;

        // Build map: expectedBaseName -> qid
        const imageMap = {};

        Object.entries(ALL_QUESTIONS).forEach(([qid, q]) => {
          if (IMG) return;

          // split comma separated images
          const images = q.IMG.split(",");

          images.forEach((IMG) => {
            const base = normalizeName(IMG);

            if (base) {
              imageMap[base] = qid;
            }
          });
        });

        BULK_FILES = [];
        const grid = document.getElementById("bulkImageGrid");
        grid.innerHTML = "";

        let matched = 0;

        files.forEach((file) => {
          const base = normalizeName(file.name);
          const qid = imageMap[base];
          const isMatched = !!qid;

          if (isMatched) matched++;

          console.log(
            `${isMatched ? "‚úî MATCHED" : "‚úñ NOT MATCHED"} | Image: ${file.name} | QID: ${qid || "None"}`,
          );

          BULK_FILES.push({ file, qid, matched: isMatched });

          const card = document.createElement("div");
          card.style.border = "1px solid #e5e7eb";
          card.style.borderRadius = "10px";
          card.style.padding = "10px";
          card.style.fontSize = "12px";

          card.innerHTML = `
      <img src="${URL.createObjectURL(file)}" style="width:100%; height:120px; object-fit:cover; border-radius:8px;" />
      <div style="margin-top:6px; font-weight:600;">${file.name}</div>
      <div style="color:${isMatched ? "#059669" : "#dc2626"}; margin-top:4px;">
        ${isMatched ? "‚úî Matched (" + qid + ")" : "‚úñ No matching question"}
      </div>
    `;

          grid.appendChild(card);
        });

        document.getElementById("bulkStats").innerText =
          `Selected: ${files.length} | Matched: ${matched} | Skipped: ${files.length - matched}`;
      }
      async function startBulkUpload() {
        const matchedFiles = BULK_FILES.filter((f) => f.matched);
        if (!matchedFiles.length) {
          alert("No matched images to upload.");
          return;
        }

        showLoader(); // üëà ONE loader for everything

        let success = 0;
        let failed = 0;

        try {
          for (const item of matchedFiles) {
            const ok = await uploadQuestionImage(item.qid, item.file, true); // üëà silent
            if (ok) success++;
            else failed++;
          }
        } finally {
          hideLoader();
        }

        alert(
          `‚úÖ Bulk Upload Complete\n\nUploaded: ${success}\nFailed: ${failed}`,
        );

        closeBulkModal();
      }
      function normalizeName(name) {
        return removeExtension(name).trim().toLowerCase().replace(/\s+/g, " "); // normalize spaces
      }

      function downloadFilteredExcel() {
        const table = document.getElementById("excelTable");

        if (!table || table.rows.length <= 1) {
          alert("No filtered data available to download.");
          return;
        }

        // Clone table to avoid modifying UI
        const cloneTable = table.cloneNode(true);

        // üîé Apply search filter (only visible rows)
        const rows = cloneTable.querySelectorAll("tr");
        rows.forEach((row, index) => {
          if (index === 0) return; // header

          const originalRow = table.rows[index];
          if (originalRow && originalRow.style.display === "none") {
            row.remove();
          }
        });

        if (cloneTable.rows.length <= 1) {
          alert("No visible rows after filtering.");
          return;
        }

        /* ‚ùå REMOVE ACTIONS COLUMN (LAST COLUMN) */
        const actionColIndex = cloneTable.rows[0].cells.length - 1;
        Array.from(cloneTable.rows).forEach((row) => {
          row.deleteCell(actionColIndex);
        });

        /* ‚ùå REMOVE `reason` COLUMN IF EXISTS */
        const headers = Array.from(cloneTable.rows[0].cells).map((c) =>
          c.innerText.trim(),
        );
        const reasonIndex = headers.indexOf("reason");

        if (reasonIndex !== -1) {
          Array.from(cloneTable.rows).forEach((row) => {
            row.deleteCell(reasonIndex);
          });
        }

        // Convert to Excel
        const ws = XLSX.utils.table_to_sheet(cloneTable);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Filtered Questions");

        XLSX.writeFile(wb, "selected_questions.xlsx");
      }

      ///bulk excel upload
      function selectExcelFile() {
        document.getElementById("excelUploadInput").click();
      }
      async function handleExcelUpload(input) {
        const file = input.files[0];
        if (!file) return;

        showLoader();

        try {
          const data = await file.arrayBuffer();
          const workbook = XLSX.read(data, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet);

          if (!rows.length || !rows[0].QID) {
            alert("‚ùå Excel must contain a QID column");
            return;
          }

          let updated = 0;
          let skipped = 0;

          for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const qid = String(row.QID || "").trim();

            if (!qid) {
              skipped++;
              continue;
            }

            const { QID, ...data } = row;

            try {
              const res = await fetch(`${API}/update-question`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ qid, data }),
              });

              const json = await res.json();

              if (json.updated) updated++;
              else skipped++;
            } catch (e) {
              console.error("Failed QID:", qid, e);
              skipped++;
            }
          }

          alert(
            `‚úÖ Excel Upload Complete\n\nUpdated: ${updated}\nSkipped: ${skipped}`,
          );
        } catch (err) {
          console.error(err);
          alert("‚ùå Failed to process Excel");
        } finally {
          hideLoader();
          input.value = "";
        }
      }
    </script>
    <!-- ============ BULK IMAGE UPLOAD MODAL ============ -->
    <div
      id="bulkUploadModal"
      style="
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 10000;
        justify-content: center;
        align-items: center;
      "
    >
      <div
        style="
          width: 90%;
          height: 90%;
          background: #fff;
          border-radius: 16px;
          display: flex;
          flex-direction: column;
          overflow: hidden;
        "
      >
        <!-- Header -->
        <div
          style="
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <h2 style="margin: 0; font-size: 18px">Bulk Image Upload</h2>
          <button
            onclick="closeBulkModal()"
            style="
              font-size: 22px;
              border: none;
              background: none;
              cursor: pointer;
            "
          >
            ‚úï
          </button>
        </div>

        <!-- Actions -->
        <div style="padding: 14px 20px; display: flex; gap: 12px">
          <button class="btn" onclick="selectBulkImages()">
            Select Images
          </button>
          <button class="btn btn-green" onclick="startBulkUpload()">
            Upload Matched
          </button>

          <div
            id="bulkStats"
            style="margin-left: auto; font-size: 14px; color: #374151"
          ></div>
        </div>

        <!-- Grid -->
        <div
          id="bulkImageGrid"
          style="
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
          "
        ></div>
      </div>
    </div>

    <input
      id="bulkImageInput"
      type="file"
      accept="image/*"
      multiple
      style="display: none"
      onchange="handleBulkPreview(this)"
    />
    <input
      id="excelUploadInput"
      type="file"
      accept=".xlsx"
      style="display: none"
      onchange="handleExcelUpload(this)"
    />
  </body>
</html>
